let worker = new Worker('./worker.js');

function adjustShortage() {
  if (!latestInput || Object.keys(latestInput).length === 0) {
    document.getElementById("adjustmentResult").innerText = "※ 先に「不足を計算する」を押してください。";
    return;
  }

  const input = latestInput;
  const autoFixed = new Set(
    denominations.filter(denom => input[denom] >= baseTargets[denom])
  );

  document.getElementById("adjustmentResult").innerText = "調整中です...";

  worker.onmessage = function (e) {
    const best = e.data;
    if (!best) {
      document.getElementById("adjustmentResult").innerText = "※ 補填できませんでした。";
      return;
    }

    let resultText = `【調整後不足金種】\n`;
    const { shortage, shortageTotal, combo } = best;

    for (let denom of denominations) {
      if (shortage[denom]) {
        resultText += `${denom}円×${shortage[denom]}枚 = ${denom * shortage[denom]}円\n`;
      }
    }
    resultText += `不足合計　${shortageTotal.toLocaleString()}円\n\n`;

    resultText += `【補填内訳】\n`;
    let 補填合計 = 0;
    for (let denom of denominations) {
      if (combo[denom]) {
        const amount = denom * combo[denom];
        補填合計 += amount;
        resultText += `${denom}円×${combo[denom]}枚 = ${amount.toLocaleString()}円\n`;
      }
    }
    resultText += `補填合計　${補填合計.toLocaleString()}円`;

    document.getElementById("adjustmentResult").innerText = resultText;
  };

  worker.postMessage({
    input,
    baseTargets,
    excludeSetArray: Array.from(autoFixed),
    maxTry: 12
  });
}